name: Deploy Mentor to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            set -euo pipefail

            # Preserve query string when nginx redirects /mentor -> /mentor/
            # (otherwise /mentor?domain=cpp becomes /mentor/ and domain switching breaks).
            NGINX_SITE="/etc/nginx/sites-available/alimoustafa.in"
            if [ -f "$NGINX_SITE" ]; then
              mkdir -p /root/nginx-backups
              cp -f "$NGINX_SITE" "/root/nginx-backups/alimoustafa.in.$(date +%Y%m%d-%H%M%S).conf"

              # 1) Fix common explicit redirects that drop query strings.
              # Examples:
              # - return 301 /mentor/;
              # - return 302 https://$host/mentor/;
              perl -i -pe '
                s/return\\s+30[12]\\s+((?:https?:\\/\\/[^;\\s]+)?\\/mentor\\/)(?!\\$is_args\\$args)\\s*;/return 301 $1\\$is_args\\$args;/g;
              ' "$NGINX_SITE"

              # 2) Ensure a dedicated redirect location exists and preserves args (best-effort insertion).
              perl -0777 -i -pe '
                if ($_ !~ /location\\s*=\\s*\\/mentor\\s*\\{/s) {
                  s/(server\\s*\\{)/$1\\n\\n    location = \\/mentor {\\n        return 301 \\/mentor\\/\\$is_args\\$args;\\n    }\\n/s;
                }
              ' "$NGINX_SITE"

              nginx -t
              systemctl reload nginx
            fi

            cd /var/www/mentor
            git config --global --add safe.directory /var/www/mentor || true
            git pull origin main

            docker volume inspect mentor_dbdata >/dev/null 2>&1 || docker volume create mentor_dbdata >/dev/null

            # Build Vite assets on the host filesystem (bind-mounted into containers).
            docker run --rm -v "$PWD":/app -w /app node:20-alpine sh -lc 'npm install --no-audit --no-fund && npm run build'
            rm -f public/hot || true

            docker compose -f docker-compose.prod.yml up -d --build

            docker compose -f docker-compose.prod.yml exec -T app composer install --no-interaction --prefer-dist --no-dev --optimize-autoloader
            docker compose -f docker-compose.prod.yml exec -T app php artisan migrate --force
            docker compose -f docker-compose.prod.yml exec -T app php artisan db:seed --class=DomainSeeder --force
            docker compose -f docker-compose.prod.yml exec -T app php artisan optimize:clear

            chown -R 33:33 /var/www/mentor
